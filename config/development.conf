# AirAccount 项目开发环境配置
# 此文件包含开发环境相关的所有配置参数

# ====================
# Docker 配置
# ====================
export DOCKER_IMAGE="teaclave/teaclave-trustzone-emulator-nostd-optee-4.5.0-expand-memory:latest"
export DOCKER_CONTAINER_NAME="airaccount-dev"
export DOCKER_WORK_DIR="/root/teaclave_sdk_src"

# ====================
# OP-TEE 环境配置
# ====================
export OPTEE_CLIENT_EXPORT="/opt/teaclave/optee/optee_client/export_arm64"
export TA_DEV_KIT_DIR="/opt/teaclave/optee/optee_os/out/arm-plat-vexpress/export-ta_arm64"
export OPTEE_OS_DIR="/opt/teaclave/optee/optee_os"

# ====================
# 构建配置
# ====================
export BUILD_TARGET="aarch64-unknown-linux-gnu"
export CROSS_COMPILE="aarch64-linux-gnu-"
export RUST_TARGET_ARM64="aarch64-unknown-linux-gnu"
export RUST_TARGET_OPTEE="aarch64-unknown-optee-trustzone"

# ====================
# 项目路径配置
# ====================
# 注意：AIRACCOUNT_ROOT 将由加载此配置的脚本动态设置
export AIRACCOUNT_ROOT="${AIRACCOUNT_ROOT:-}"
export SDK_DIR="${AIRACCOUNT_ROOT}/third_party/incubator-teaclave-trustzone-sdk"
export SCRIPTS_DIR="$AIRACCOUNT_ROOT/scripts"
export DOCS_DIR="$AIRACCOUNT_ROOT/docs"
export CONFIG_DIR="$AIRACCOUNT_ROOT/config"

# ====================
# 网络配置
# ====================
export HTTP_PROXY="${HTTP_PROXY:-}"
export HTTPS_PROXY="${HTTPS_PROXY:-}"
export NO_PROXY="${NO_PROXY:-localhost,127.0.0.1}"

# ====================
# 开发工具配置
# ====================
export RUST_LOG="${RUST_LOG:-info}"
export RUST_BACKTRACE="${RUST_BACKTRACE:-1}"
export CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-$AIRACCOUNT_ROOT/target}"
export CARGO_HOME="${CARGO_HOME:-$HOME/.cargo}"

# ====================
# 测试配置
# ====================
export TEST_TIMEOUT="${TEST_TIMEOUT:-300}" # 5分钟超时
export TEST_PARALLEL="${TEST_PARALLEL:-1}"
export BENCHMARK_ITERATIONS="${BENCHMARK_ITERATIONS:-1000}"

# ====================
# 安全配置
# ====================
export SECURE_RANDOM_SEED_SIZE="${SECURE_RANDOM_SEED_SIZE:-32}"
export KEY_ROTATION_INTERVAL_HOURS="${KEY_ROTATION_INTERVAL_HOURS:-24}"
export MAX_SIGNATURE_REQUESTS_PER_MINUTE="${MAX_SIGNATURE_REQUESTS_PER_MINUTE:-100}"

# ====================
# 日志配置
# ====================
export LOG_LEVEL="${LOG_LEVEL:-INFO}"
export LOG_FILE="${LOG_FILE:-$AIRACCOUNT_ROOT/logs/airaccount.log}"
export LOG_MAX_SIZE="${LOG_MAX_SIZE:-10MB}"
export LOG_MAX_FILES="${LOG_MAX_FILES:-5}"

# ====================
# 资源限制配置
# ====================
export MAX_MEMORY_MB="${MAX_MEMORY_MB:-1024}"
export MAX_CPU_PERCENT="${MAX_CPU_PERCENT:-80}"
export MIN_DISK_SPACE_GB="${MIN_DISK_SPACE_GB:-5}"

# ====================
# CI/CD 配置
# ====================
export CI_ENABLED="${CI_ENABLED:-false}"
export BUILD_NUMBER="${BUILD_NUMBER:-local}"
export GIT_COMMIT="${GIT_COMMIT:-$(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')}"
export BUILD_TIMESTAMP="${BUILD_TIMESTAMP:-$(date -u +%Y%m%d_%H%M%S)}"

# ====================
# 版本信息
# ====================
export AIRACCOUNT_VERSION="${AIRACCOUNT_VERSION:-0.1.0-dev}"
export TEACLAVE_SDK_VERSION="${TEACLAVE_SDK_VERSION:-latest}"
export OPTEE_VERSION="${OPTEE_VERSION:-4.5.0}"

# ====================
# 功能开关
# ====================
export ENABLE_SECURITY_AUDIT="${ENABLE_SECURITY_AUDIT:-true}"
export ENABLE_PERFORMANCE_MONITORING="${ENABLE_PERFORMANCE_MONITORING:-true}"
export ENABLE_DETAILED_LOGGING="${ENABLE_DETAILED_LOGGING:-true}"
export ENABLE_AUTOMATIC_TESTING="${ENABLE_AUTOMATIC_TESTING:-true}"

# ====================
# 验证配置完整性
# ====================
_validate_config() {
    local required_vars=(
        "DOCKER_IMAGE"
        "OPTEE_CLIENT_EXPORT" 
        "TA_DEV_KIT_DIR"
        "BUILD_TARGET"
        "SDK_DIR"
        "AIRACCOUNT_ROOT"
    )
    
    local missing_vars=()
    for var in "${required_vars[@]}"; do
        if [[ -z "${!var:-}" ]]; then
            missing_vars+=("$var")
        fi
    done
    
    if [[ ${#missing_vars[@]} -gt 0 ]]; then
        echo "❌ 配置验证失败，缺少必需变量: ${missing_vars[*]}" >&2
        return 1
    fi
    
    echo "✅ 配置验证通过"
    return 0
}

# 自动验证配置
if ! _validate_config; then
    echo "⚠️  配置文件存在问题，请检查后重新加载" >&2
fi