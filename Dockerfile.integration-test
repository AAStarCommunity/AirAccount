FROM ubuntu:24.04

# è®¾ç½®ç¯å¢ƒ
ENV DEBIAN_FRONTEND=noninteractive
ENV TERM=xterm-256color

# å®‰è£…å¿…è¦ä¾èµ–
RUN apt-get update && apt-get install -y \
    qemu-system-aarch64 \
    screen \
    expect \
    file \
    bsdmainutils \
    util-linux \
    socat \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºå·¥ä½œç›®å½•
WORKDIR /airaccount-test

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY packages/airaccount-ta-simple/target/aarch64-unknown-linux-gnu/release/11223344-5566-7788-99aa-bbccddeeff01.ta ./
COPY packages/airaccount-ca/target/aarch64-unknown-linux-gnu/debug/airaccount-ca ./

# å¤åˆ¶QEMUé•œåƒ
COPY third_party/incubator-teaclave-trustzone-sdk/tests/aarch64-optee-4.7.0-qemuv8-ubuntu-24.04 ./qemu-env

# è®¾ç½®æƒé™
RUN chmod +x ./airaccount-ca

# åˆ›å»ºéªŒè¯è„šæœ¬
RUN echo '#!/bin/bash' > ./verify_components.sh && \
    echo 'echo "ğŸ” AirAccounté›†æˆæµ‹è¯•éªŒè¯"' >> ./verify_components.sh && \
    echo 'echo "========================="' >> ./verify_components.sh && \
    echo 'echo ""' >> ./verify_components.sh && \
    echo '# æ£€æŸ¥TAæ–‡ä»¶' >> ./verify_components.sh && \
    echo 'ta_file=$(ls *.ta)' >> ./verify_components.sh && \
    echo 'if [ -f "$ta_file" ]; then' >> ./verify_components.sh && \
    echo '  echo "âœ… TAæ–‡ä»¶å­˜åœ¨: $ta_file"' >> ./verify_components.sh && \
    echo '  echo "   å¤§å°: $(stat -c%s "$ta_file") bytes"' >> ./verify_components.sh && \
    echo '  if hexdump -C "$ta_file" | head -1 | grep -q "48 53 54 4f"; then' >> ./verify_components.sh && \
    echo '    echo "   âœ… OP-TEE HSTOæ ¼å¼æ­£ç¡®"' >> ./verify_components.sh && \
    echo '  else' >> ./verify_components.sh && \
    echo '    echo "   âŒ OP-TEEæ ¼å¼éªŒè¯å¤±è´¥"' >> ./verify_components.sh && \
    echo '  fi' >> ./verify_components.sh && \
    echo 'else' >> ./verify_components.sh && \
    echo '  echo "âŒ TAæ–‡ä»¶ç¼ºå¤±"' >> ./verify_components.sh && \
    echo 'fi' >> ./verify_components.sh && \
    echo 'echo ""' >> ./verify_components.sh && \
    echo '# æ£€æŸ¥CAæ–‡ä»¶' >> ./verify_components.sh && \
    echo 'if [ -f "./airaccount-ca" ]; then' >> ./verify_components.sh && \
    echo '  echo "âœ… CAæ–‡ä»¶å­˜åœ¨: airaccount-ca"' >> ./verify_components.sh && \
    echo '  echo "   å¤§å°: $(stat -c%s ./airaccount-ca) bytes"' >> ./verify_components.sh && \
    echo '  echo "   ç±»å‹: $(file ./airaccount-ca)"' >> ./verify_components.sh && \
    echo 'else' >> ./verify_components.sh && \
    echo '  echo "âŒ CAæ–‡ä»¶ç¼ºå¤±"' >> ./verify_components.sh && \
    echo 'fi' >> ./verify_components.sh && \
    echo 'echo ""' >> ./verify_components.sh && \
    echo '# æ£€æŸ¥QEMUç¯å¢ƒ' >> ./verify_components.sh && \
    echo 'if [ -d "./qemu-env" ]; then' >> ./verify_components.sh && \
    echo '  echo "âœ… QEMUç¯å¢ƒç›®å½•å­˜åœ¨"' >> ./verify_components.sh && \
    echo '  echo "   æ–‡ä»¶æ•°: $(ls qemu-env/ | wc -l)"' >> ./verify_components.sh && \
    echo '  if [ -f "./qemu-env/Image" ] && [ -f "./qemu-env/bl1.bin" ]; then' >> ./verify_components.sh && \
    echo '    echo "   âœ… æ ¸å¿ƒQEMUæ–‡ä»¶å­˜åœ¨ï¼ˆImage, bl1.binï¼‰"' >> ./verify_components.sh && \
    echo '  else' >> ./verify_components.sh && \
    echo '    echo "   âŒ ç¼ºå°‘QEMUæ ¸å¿ƒæ–‡ä»¶"' >> ./verify_components.sh && \
    echo '  fi' >> ./verify_components.sh && \
    echo 'else' >> ./verify_components.sh && \
    echo '  echo "âŒ QEMUç¯å¢ƒç›®å½•ç¼ºå¤±"' >> ./verify_components.sh && \
    echo 'fi' >> ./verify_components.sh && \
    echo 'echo ""' >> ./verify_components.sh && \
    echo 'echo "ğŸ–¥ï¸  ç³»ç»ŸQEMUæ£€æŸ¥"' >> ./verify_components.sh && \
    echo 'if command -v qemu-system-aarch64 >/dev/null 2>&1; then' >> ./verify_components.sh && \
    echo '  echo "âœ… ç³»ç»ŸQEMUå¯ç”¨: $(qemu-system-aarch64 --version | head -1)"' >> ./verify_components.sh && \
    echo 'else' >> ./verify_components.sh && \
    echo '  echo "âŒ ç³»ç»ŸQEMUä¸å¯ç”¨"' >> ./verify_components.sh && \
    echo 'fi' >> ./verify_components.sh

# åˆ›å»ºQEMUå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash' > ./start_optee.sh && \
    echo 'echo "ğŸš€ å¯åŠ¨OP-TEE QEMUç¯å¢ƒ"' >> ./start_optee.sh && \
    echo 'echo "======================"' >> ./start_optee.sh && \
    echo '' >> ./start_optee.sh && \
    echo '# æ£€æŸ¥QEMUç¯å¢ƒ' >> ./start_optee.sh && \
    echo 'if [ ! -d "./qemu-env" ]; then' >> ./start_optee.sh && \
    echo '  echo "âŒ QEMUç¯å¢ƒç›®å½•ä¸å­˜åœ¨ï¼Œæ— æ³•å¯åŠ¨"' >> ./start_optee.sh && \
    echo '  exit 1' >> ./start_optee.sh && \
    echo 'fi' >> ./start_optee.sh && \
    echo '' >> ./start_optee.sh && \
    echo 'cd qemu-env' >> ./start_optee.sh && \
    echo '' >> ./start_optee.sh && \
    echo '# åˆ›å»ºå…±äº«ç›®å½•' >> ./start_optee.sh && \
    echo 'mkdir -p ../shared' >> ./start_optee.sh && \
    echo 'cp ../*.ta ../shared/ 2>/dev/null || true' >> ./start_optee.sh && \
    echo 'cp ../airaccount-ca ../shared/ 2>/dev/null || true' >> ./start_optee.sh && \
    echo 'chmod +x ../shared/airaccount-ca 2>/dev/null || true' >> ./start_optee.sh && \
    echo '' >> ./start_optee.sh && \
    echo 'echo "ğŸ“ å…±äº«ç›®å½•å·²å‡†å¤‡å®Œæˆ"' >> ./start_optee.sh && \
    echo 'echo "   å…±äº«æ–‡ä»¶: $(ls -la ../shared/)"' >> ./start_optee.sh && \
    echo 'echo ""' >> ./start_optee.sh && \
    echo 'echo "ğŸ® å¯åŠ¨QEMUï¼ˆæŒ‰ Ctrl+A ç„¶å X é€€å‡ºï¼‰"' >> ./start_optee.sh && \
    echo 'echo ""' >> ./start_optee.sh && \
    echo 'sleep 2' >> ./start_optee.sh && \
    echo '' >> ./start_optee.sh && \
    echo '# å¯åŠ¨QEMU' >> ./start_optee.sh && \
    echo 'exec qemu-system-aarch64 \\' >> ./start_optee.sh && \
    echo '    -nographic \\' >> ./start_optee.sh && \
    echo '    -serial mon:stdio \\' >> ./start_optee.sh && \
    echo '    -smp 2 \\' >> ./start_optee.sh && \
    echo '    -machine virt,secure=on,acpi=off,gic-version=3 \\' >> ./start_optee.sh && \
    echo '    -cpu cortex-a57 \\' >> ./start_optee.sh && \
    echo '    -d unimp -semihosting-config enable=on,target=native \\' >> ./start_optee.sh && \
    echo '    -m 1057 \\' >> ./start_optee.sh && \
    echo '    -bios bl1.bin \\' >> ./start_optee.sh && \
    echo '    -initrd rootfs.cpio.gz \\' >> ./start_optee.sh && \
    echo '    -kernel Image \\' >> ./start_optee.sh && \
    echo '    -append "console=ttyAMA0,115200 keep_bootcon root=/dev/vda2" \\' >> ./start_optee.sh && \
    echo '    -fsdev local,id=fsdev0,path=../shared,security_model=none \\' >> ./start_optee.sh && \
    echo '    -device virtio-9p-device,fsdev=fsdev0,mount_tag=host \\' >> ./start_optee.sh && \
    echo '    -netdev user,id=vmnic \\' >> ./start_optee.sh && \
    echo '    -device virtio-net-device,netdev=vmnic' >> ./start_optee.sh

# è®¾ç½®æ‰§è¡Œæƒé™
RUN chmod +x ./verify_components.sh ./start_optee.sh

# é»˜è®¤å‘½ä»¤
CMD ["./verify_components.sh"]