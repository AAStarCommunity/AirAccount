FROM ubuntu:24.04

# è®¾ç½®ç¯å¢ƒ
ENV DEBIAN_FRONTEND=noninteractive

# å®‰è£…å¿…è¦ä¾èµ–
RUN apt-get update && apt-get install -y \
    qemu-system-aarch64 \
    file \
    bsdmainutils \
    util-linux \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºå·¥ä½œç›®å½•
WORKDIR /test

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY packages/airaccount-ta-simple/target/aarch64-unknown-linux-gnu/release/11223344-5566-7788-99aa-bbccddeeff01.ta ./
COPY packages/airaccount-ca/target/aarch64-unknown-linux-gnu/debug/airaccount-ca ./

# è®¾ç½®æƒé™
RUN chmod +x ./airaccount-ca

# åˆ›å»ºæµ‹è¯•è„šæœ¬
RUN echo '#!/bin/bash' > ./run_basic_tests.sh && \
    echo 'echo "ğŸ§ª AirAccountåŸºç¡€åŠŸèƒ½æ¨¡æ‹Ÿæµ‹è¯•"' >> ./run_basic_tests.sh && \
    echo 'echo "==========================="' >> ./run_basic_tests.sh && \
    echo 'echo ""' >> ./run_basic_tests.sh && \
    echo '# åŸºç¡€ç»„ä»¶éªŒè¯' >> ./run_basic_tests.sh && \
    echo 'echo "ğŸ“‹ ç»„ä»¶æ£€æŸ¥:"' >> ./run_basic_tests.sh && \
    echo 'ta_file=$(ls *.ta 2>/dev/null | head -1)' >> ./run_basic_tests.sh && \
    echo 'if [ -f "$ta_file" ]; then' >> ./run_basic_tests.sh && \
    echo '  echo "  âœ… TAæ–‡ä»¶: $ta_file ($(stat -c%s "$ta_file") bytes)"' >> ./run_basic_tests.sh && \
    echo '  if hexdump -C "$ta_file" | head -1 | grep -q "48 53 54 4f"; then' >> ./run_basic_tests.sh && \
    echo '    echo "     âœ… OP-TEEæ ¼å¼éªŒè¯é€šè¿‡"' >> ./run_basic_tests.sh && \
    echo '  fi' >> ./run_basic_tests.sh && \
    echo 'fi' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo 'if [ -f "./airaccount-ca" ]; then' >> ./run_basic_tests.sh && \
    echo '  echo "  âœ… CAæ–‡ä»¶: airaccount-ca ($(stat -c%s ./airaccount-ca) bytes)"' >> ./run_basic_tests.sh && \
    echo '  echo "     æ¶æ„: $(file ./airaccount-ca | grep -o "ARM aarch64" || echo "æœªæ£€æµ‹åˆ°ARM64")"' >> ./run_basic_tests.sh && \
    echo 'fi' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo 'echo ""' >> ./run_basic_tests.sh && \
    echo 'echo "ğŸ–¥ï¸  QEMUç¯å¢ƒæ£€æŸ¥:"' >> ./run_basic_tests.sh && \
    echo 'if command -v qemu-system-aarch64 >/dev/null 2>&1; then' >> ./run_basic_tests.sh && \
    echo '  echo "  âœ… QEMUå¯ç”¨: $(qemu-system-aarch64 --version | head -1)"' >> ./run_basic_tests.sh && \
    echo '  qemu_available=1' >> ./run_basic_tests.sh && \
    echo 'else' >> ./run_basic_tests.sh && \
    echo '  echo "  âŒ QEMUä¸å¯ç”¨"' >> ./run_basic_tests.sh && \
    echo '  qemu_available=0' >> ./run_basic_tests.sh && \
    echo 'fi' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo 'echo ""' >> ./run_basic_tests.sh && \
    echo 'echo "ğŸ§ª æ¨¡æ‹Ÿæµ‹è¯•ï¼ˆæ— å®é™…TEEç¯å¢ƒï¼‰:"' >> ./run_basic_tests.sh && \
    echo 'echo "  â„¹ï¸  ç”±äºç¼ºå°‘å®Œæ•´çš„OP-TEEç¯å¢ƒï¼Œæ‰§è¡Œæ¨¡æ‹Ÿæµ‹è¯•"' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo '# Test 1: æ–‡ä»¶å®Œæ•´æ€§éªŒè¯' >> ./run_basic_tests.sh && \
    echo 'echo "  Test 1: æ–‡ä»¶å®Œæ•´æ€§éªŒè¯"' >> ./run_basic_tests.sh && \
    echo 'if [ -f "$ta_file" ] && [ -f "./airaccount-ca" ]; then' >> ./run_basic_tests.sh && \
    echo '  echo "     âœ… æ‰€æœ‰å¿…éœ€æ–‡ä»¶å­˜åœ¨"' >> ./run_basic_tests.sh && \
    echo '  test1_pass=1' >> ./run_basic_tests.sh && \
    echo 'else' >> ./run_basic_tests.sh && \
    echo '  echo "     âŒ æ–‡ä»¶ç¼ºå¤±"' >> ./run_basic_tests.sh && \
    echo '  test1_pass=0' >> ./run_basic_tests.sh && \
    echo 'fi' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo '# Test 2: CAå¯æ‰§è¡Œæ€§æ£€æŸ¥' >> ./run_basic_tests.sh && \
    echo 'echo "  Test 2: CAå¯æ‰§è¡Œæ€§æ£€æŸ¥"' >> ./run_basic_tests.sh && \
    echo 'if file ./airaccount-ca | grep -q "executable"; then' >> ./run_basic_tests.sh && \
    echo '  echo "     âœ… CAæ–‡ä»¶ä¸ºå¯æ‰§è¡Œæ ¼å¼"' >> ./run_basic_tests.sh && \
    echo '  test2_pass=1' >> ./run_basic_tests.sh && \
    echo 'else' >> ./run_basic_tests.sh && \
    echo '  echo "     âŒ CAæ–‡ä»¶æ ¼å¼é”™è¯¯"' >> ./run_basic_tests.sh && \
    echo '  test2_pass=0' >> ./run_basic_tests.sh && \
    echo 'fi' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo '# Test 3: å°è¯•åŸºæœ¬çš„å¸®åŠ©è¾“å‡ºï¼ˆå¯èƒ½å¤±è´¥ï¼Œå› ä¸ºéœ€è¦OP-TEEï¼‰' >> ./run_basic_tests.sh && \
    echo 'echo "  Test 3: CAåŸºæœ¬åŠŸèƒ½æµ‹è¯•"' >> ./run_basic_tests.sh && \
    echo 'timeout 5 ./airaccount-ca --help 2>/dev/null >/dev/null && help_exit=$? || help_exit=$?' >> ./run_basic_tests.sh && \
    echo 'if [ "$help_exit" -eq 0 ] || [ "$help_exit" -eq 1 ]; then' >> ./run_basic_tests.sh && \
    echo '  echo "     âœ… CAç¨‹åºå¯ä»¥å¯åŠ¨ï¼ˆé€€å‡ºç : $help_exitï¼‰"' >> ./run_basic_tests.sh && \
    echo '  test3_pass=1' >> ./run_basic_tests.sh && \
    echo 'elif [ "$help_exit" -eq 124 ]; then' >> ./run_basic_tests.sh && \
    echo '  echo "     âš ï¸  CAç¨‹åºè¶…æ—¶ï¼ˆå¯èƒ½ç­‰å¾…TEEè¿æ¥ï¼‰"' >> ./run_basic_tests.sh && \
    echo '  test3_pass=1' >> ./run_basic_tests.sh && \
    echo 'else' >> ./run_basic_tests.sh && \
    echo '  echo "     âŒ CAç¨‹åºå¯åŠ¨å¤±è´¥ï¼ˆé€€å‡ºç : $help_exitï¼‰"' >> ./run_basic_tests.sh && \
    echo '  test3_pass=0' >> ./run_basic_tests.sh && \
    echo 'fi' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo '# æ€»ç»“' >> ./run_basic_tests.sh && \
    echo 'echo ""' >> ./run_basic_tests.sh && \
    echo 'echo "ğŸ“Š æµ‹è¯•ç»“æœæ€»ç»“:"' >> ./run_basic_tests.sh && \
    echo 'total_tests=3' >> ./run_basic_tests.sh && \
    echo 'passed_tests=$((test1_pass + test2_pass + test3_pass))' >> ./run_basic_tests.sh && \
    echo 'echo "  é€šè¿‡æµ‹è¯•: $passed_tests/$total_tests"' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo 'if [ "$passed_tests" -eq "$total_tests" ]; then' >> ./run_basic_tests.sh && \
    echo '  echo "  ğŸ‰ æ‰€æœ‰åŸºç¡€æµ‹è¯•é€šè¿‡ï¼"' >> ./run_basic_tests.sh && \
    echo '  echo "  âœ… AirAccountç»„ä»¶å·²å‡†å¤‡å°±ç»ªï¼Œå¯éƒ¨ç½²åˆ°çœŸå®çš„OP-TEEç¯å¢ƒ"' >> ./run_basic_tests.sh && \
    echo 'elif [ "$passed_tests" -gt 1 ]; then' >> ./run_basic_tests.sh && \
    echo '  echo "  âœ… å¤§éƒ¨åˆ†æµ‹è¯•é€šè¿‡ï¼Œç»„ä»¶åŸºæœ¬å°±ç»ª"' >> ./run_basic_tests.sh && \
    echo '  echo "  â„¹ï¸  å»ºè®®åœ¨çœŸå®OP-TEEç¯å¢ƒä¸­è¿›è¡Œå®Œæ•´æµ‹è¯•"' >> ./run_basic_tests.sh && \
    echo 'else' >> ./run_basic_tests.sh && \
    echo '  echo "  âŒ å¤šä¸ªæµ‹è¯•å¤±è´¥ï¼Œéœ€è¦æ£€æŸ¥æ„å»ºé—®é¢˜"' >> ./run_basic_tests.sh && \
    echo 'fi' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo 'echo ""' >> ./run_basic_tests.sh && \
    echo 'echo "ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®:"' >> ./run_basic_tests.sh && \
    echo 'echo "  1. åœ¨çœŸå®çš„ARM64 Linux + OP-TEEç¯å¢ƒä¸­éƒ¨ç½²æµ‹è¯•"' >> ./run_basic_tests.sh && \
    echo 'echo "  2. å¤åˆ¶TAæ–‡ä»¶åˆ° /lib/optee_armtz/"' >> ./run_basic_tests.sh && \
    echo 'echo "  3. è¿è¡Œå‘½ä»¤ï¼š./airaccount-ca hello"' >> ./run_basic_tests.sh && \
    echo 'echo "  4. è¿è¡Œå‘½ä»¤ï¼š./airaccount-ca echo \\"Hello TEE\\""' >> ./run_basic_tests.sh && \
    echo 'echo "  5. è¿è¡Œå‘½ä»¤ï¼š./airaccount-ca test"' >> ./run_basic_tests.sh

# è®¾ç½®æƒé™
RUN chmod +x ./run_basic_tests.sh

# é»˜è®¤å‘½ä»¤
CMD ["./run_basic_tests.sh"]