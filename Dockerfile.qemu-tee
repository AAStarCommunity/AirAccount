# Licensed to AirAccount under the Apache License, Version 2.0
# QEMU-based OP-TEEç¯å¢ƒç”¨äºçœŸå®TEEå¼€å‘

FROM ubuntu:20.04

ENV DEBIAN_FRONTEND=noninteractive
ENV PATH="/usr/local/bin:$PATH"

# å®‰è£…å¿…è¦å·¥å…·
RUN apt-get update && apt-get install -y \
    build-essential \
    git \
    python3 \
    python3-pip \
    curl \
    wget \
    cmake \
    libssl-dev \
    pkg-config \
    gcc-aarch64-linux-gnu \
    qemu-system-arm \
    device-tree-compiler \
    bison \
    flex \
    bc \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…Rustå·¥å…·é“¾
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:$PATH"
RUN rustup target add aarch64-unknown-linux-gnu

# å·¥ä½œç›®å½•
WORKDIR /workspace

# å¤åˆ¶æºç 
COPY . .

# æ„å»ºOP-TEEç¯å¢ƒ
RUN cd third_party/build && \
    make -j$(nproc) toolchains && \
    make -j$(nproc) -f qemu_v8.mk all

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN cat > /start_qemu.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸš€ å¯åŠ¨QEMU OP-TEEç¯å¢ƒ"
echo "===================="

cd /workspace/third_party/build

# æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»ºexample
if [[ ! -d "../optee_examples" ]]; then
    echo "ğŸ“¦ æ„å»ºOP-TEE examples..."
    make -f qemu_v8.mk ta-examples
fi

echo "ğŸ–¥ï¸  å¯åŠ¨QEMU (ARMv8 + OP-TEE)..."
echo "   ç”¨æˆ·: root (æ— å¯†ç )"
echo "   TEEç¯å¢ƒ: OP-TEE OS"
echo "   é€€å‡º: Ctrl+A, X"

# å¯åŠ¨QEMU
make -f qemu_v8.mk run
EOF

RUN chmod +x /start_qemu.sh

# åˆ›å»ºCAæ„å»ºè„šæœ¬(åœ¨QEMUå†…ä½¿ç”¨)
RUN mkdir -p /workspace/shared && cat > /workspace/shared/build_ca_in_qemu.sh << 'EOF'
#!/bin/bash
# åœ¨QEMUå†…éƒ¨è¿è¡Œçš„CAæ„å»ºè„šæœ¬

set -e
cd /root

echo "ğŸ”¨ åœ¨TEEç¯å¢ƒä¸­æ„å»ºAirAccount CA"
echo "============================="

# å®‰è£…Rust (å¦‚æœéœ€è¦)
if ! command -v cargo &> /dev/null; then
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source ~/.cargo/env
    rustup target add aarch64-unknown-linux-gnu
fi

# æ„å»ºCA
if [[ -d "/mnt/airaccount-ca" ]]; then
    cd /mnt/airaccount-ca
    
    # ä½¿ç”¨çœŸå®TEEæ¨¡å¼æ„å»º
    export OPTEE_CLIENT_EXPORT="/usr"
    cargo build --release --features real_tee
    
    echo "âœ… CAæ„å»ºæˆåŠŸ!"
    echo "ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•..."
    ./target/release/airaccount-ca test --verbose
else
    echo "âŒ CAæºç æœªæ‰¾åˆ°ï¼Œè¯·æŒ‚è½½åˆ°/mnt/airaccount-ca"
fi
EOF

RUN chmod +x /workspace/shared/build_ca_in_qemu.sh

EXPOSE 54321
CMD ["/start_qemu.sh"]