# 🚀 AirAccount TEE项目新开发者完整入门指南

## 📋 文档概述

本指南是为加入AirAccount TEE项目的新开发者准备的完整入门教程。通过本指南，您将学习如何：
- 理解项目架构和技术栈
- 搭建完整的开发环境
- 使用QEMU和Docker模拟真实TEE硬件
- 编译、运行和测试CA（客户端应用）和TA（可信应用）
- 进行日常开发和调试工作

## 🎯 学习路径

### 阶段1：理论基础 (1-2天)
- [项目架构理解](#项目架构理解)
- [TEE和OP-TEE基础知识](#tee和op-tee基础知识)

### 阶段2：环境搭建 (1天)
- [开发环境配置](#开发环境配置)
- [QEMU模拟环境设置](#qemu模拟环境设置)

### 阶段3：实践操作 (2-3天)
- [第一个测试运行](#第一个测试运行)
- [核心功能测试](#核心功能测试)
- [代码修改和调试](#代码修改和调试)

### 阶段4：加入开发 (持续)
- [开发工作流程](#开发工作流程)
- [代码贡献指南](#代码贡献指南)

---

## 🏗️ 项目架构理解

### 核心概念

**AirAccount**是一个基于TEE（可信执行环境）的跨平台Web3账户系统，主要特点：

- **硬件级安全**：私钥存储在TEE安全存储中，never leave TEE
- **双重签名机制**：客户端+TEE双重签名保证交易安全
- **跨平台支持**：支持ARM TrustZone（Raspberry Pi）和Intel SGX
- **渐进式去中心化**：从中心化MVP到完全去中心化网络

### 技术架构图

```
┌─────────────────────────────────────────────────────────┐
│                     用户应用层                              │
│  (Tauri客户端 + Web前端 + dApp SDK)                        │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                   Core Logic层                          │
│  (硬件无关的Rust业务逻辑 - 90%代码复用)                       │
│  • 钱包管理  • 签名逻辑  • 安全模块  • 网络通信                │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                   TEE适配层                             │
│  Platform-specific TEE wrappers                        │
├─────────────────────┬───────────────────────────────────┤
│    ARM TrustZone    │         Intel SGX                 │
│   (OP-TEE)         │        (SGX SDK)                  │
└─────────────────────┴───────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                   硬件TEE层                              │
│     Raspberry Pi 5      │        Intel Processors      │
│     (ARM TrustZone)     │         (SGX Enabled)        │
└─────────────────────────────────────────────────────────┘
```

### 关键组件说明

| 组件 | 描述 | 位置 |
|------|------|------|
| **TA (Trusted Application)** | 运行在TEE中的可信应用，处理私钥和签名 | `packages/ta-arm-trustzone/` |
| **CA (Client Application)** | 运行在普通世界的客户端，与TA通信 | `packages/client-ca/` |
| **Core Logic** | 硬件无关的业务逻辑库 | `packages/core-logic/` |
| **Teaclave SDK** | Apache Teaclave TrustZone SDK | `third_party/incubator-teaclave-trustzone-sdk/` |

---

## 🧠 TEE和OP-TEE基础知识

### TEE核心概念

**可信执行环境（TEE）**是处理器硬件提供的安全区域：

- **Secure World（安全世界）**：运行可信应用(TA)，处理敏感数据
- **Normal World（普通世界）**：运行常规应用(CA)，通过安全监控器与TEE通信
- **硬件隔离**：内存、寄存器、中断完全隔离
- **安全存储**：硬件加密的持久化存储

### OP-TEE架构

OP-TEE是开源的TEE实现，广泛用于ARM平台：

```
Normal World                    Secure World
┌─────────────────┐            ┌─────────────────┐
│   Linux Kernel  │            │    OP-TEE OS    │
│                 │            │                 │
│ ┌─────────────┐ │            │ ┌─────────────┐ │
│ │     CA      │◄┼────────────┼►│     TA      │ │
│ │(airaccount- │ │            │ │(airaccount. │ │
│ │    ca)      │ │            │ │    ta)      │ │
│ └─────────────┘ │            │ └─────────────┘ │
│                 │            │                 │
│ ┌─────────────┐ │            │ ┌─────────────┐ │
│ │  libteec    │ │  SMC Call  │ │ OP-TEE Core │ │
│ │   (TEE      │◄┼────────────┼►│  Services   │ │
│ │  Client)    │ │            │ │             │ │
│ └─────────────┘ │            │ └─────────────┘ │
└─────────────────┘            └─────────────────┘
        │                              │
        └──────────── ARM TrustZone ───────────┘
```

### 关键API和概念

- **TEEC_***: TEE客户端API，CA使用
- **TEE_***: TEE内部API，TA使用  
- **UUID**: 每个TA有唯一标识符
- **Session**: CA与特定TA的通信会话
- **Command**: CA向TA发送的具体操作请求

---

## 🛠️ 开发环境配置

### 系统要求

- **操作系统**: macOS (推荐), Ubuntu 20.04+, 或 Windows WSL2
- **硬盘空间**: 至少30GB可用空间
- **内存**: 至少8GB（推荐16GB+）
- **处理器**: x64架构，支持虚拟化

### 必备工具安装

#### macOS环境（推荐）
```bash
# 1. 安装 Homebrew (如果还没有)
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 2. 安装必要工具
brew install git curl qemu docker rust

# 3. 安装Xcode命令行工具
xcode-select --install

# 4. 验证安装
qemu-system-aarch64 --version
docker --version
rustc --version
```

#### Ubuntu环境
```bash
# 1. 更新系统
sudo apt update && sudo apt upgrade -y

# 2. 安装开发工具
sudo apt install -y \
    build-essential \
    git curl \
    qemu-system-arm \
    docker.io \
    python3 python3-pip \
    uuid-dev libssl-dev

# 3. 安装Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source ~/.bashrc
```

### 项目克隆和初始化

```bash
# 1. 克隆项目
git clone https://github.com/your-org/AirAccount.git
cd AirAccount

# 2. 初始化Git子模块（重要！）
git submodule update --init --recursive

# 3. 验证子模块状态
git submodule status

# 应该看到类似输出：
# +commit_hash third_party/incubator-teaclave-trustzone-sdk (tag)
```

### 环境变量配置

```bash
# 1. 设置项目环境变量
export AIRACCOUNT_ROOT=$(pwd)
export OPTEE_DIR="$AIRACCOUNT_ROOT/third_party/incubator-teaclave-trustzone-sdk"

# 2. 添加到shell配置文件（可选但推荐）
echo "export AIRACCOUNT_ROOT=$AIRACCOUNT_ROOT" >> ~/.bashrc
echo "export OPTEE_DIR=$OPTEE_DIR" >> ~/.bashrc
source ~/.bashrc
```

---

## 🖥️ QEMU模拟环境设置

AirAccount支持通过QEMU完全模拟ARM+OP-TEE环境，无需真实硬件即可开发和测试。

### QEMU环境的优势

✅ **零硬件依赖**：在任何x64机器上开发ARM TEE应用  
✅ **快速迭代**：编译后立即测试，无需烧录固件  
✅ **完全隔离**：不会影响主机系统  
✅ **调试友好**：支持GDB调试和日志输出  
✅ **CI/CD就绪**：适合自动化测试和持续集成

### OP-TEE QEMU环境组件

我们使用的QEMU环境包含：

```
QEMU虚拟机组成:
├── ARM Trusted Firmware (ATF)     - 启动加载器
├── OP-TEE OS                      - 安全世界操作系统  
├── U-Boot                         - 引导加载器
├── Linux Kernel (Ubuntu 24.04)   - 普通世界操作系统
├── Root FileSystem               - 包含测试工具和库
└── Shared Directory (9P virtio)  - 主机与虚拟机文件共享
```

### 预构建镜像验证

```bash
# 1. 进入测试目录
cd third_party/incubator-teaclave-trustzone-sdk/tests

# 2. 检查预构建的OP-TEE镜像
ls -la aarch64-optee-4.7.0-qemuv8-ubuntu-24.04/
# 应该看到：
# bl1.bin, bl2.bin, bl31.bin, bl32.bin (TEE组件)
# Image, rootfs.cpio.gz (Linux组件)
# qemu-system-aarch64 (QEMU二进制文件)

# 3. 验证QEMU启动脚本
cat optee-qemuv8-fixed.sh
```

### 第一次QEMU启动测试

```bash
# 1. 启动QEMU OP-TEE环境
cd third_party/incubator-teaclave-trustzone-sdk/tests
./optee-qemuv8-fixed.sh aarch64-optee-4.7.0-qemuv8-ubuntu-24.04

# 2. 等待启动完成（约30-60秒）
# 您会看到启动日志：
# ...
# [    0.000000] Booting Linux on physical CPU 0x0
# ...
# OP-TEE core start...
# ...
# buildroot login: 

# 3. 使用root登录（无密码）
root

# 4. 验证TEE环境
root@buildroot:~# ls /lib/optee_armtz/
# 应该为空或有一些.ta文件

root@buildroot:~# ps aux | grep tee
# 应该看到tee-supplicant进程运行中
```

### 共享目录设置

QEMU使用9P virtio文件系统实现主机与虚拟机的文件共享：

```bash
# 在QEMU虚拟机内执行：

# 1. 创建挂载点
root@buildroot:~# mkdir -p /shared

# 2. 挂载共享目录
root@buildroot:~# mount -t 9p -o trans=virtio host /shared

# 3. 验证挂载
root@buildroot:~# ls /shared/
# 这里会显示主机 tests/shared/ 目录的内容

# 4. 测试文件传输
root@buildroot:~# echo "hello from qemu" > /shared/test.txt
# 然后在主机 tests/shared/test.txt 查看此文件
```

### QEMU环境性能调优

```bash
# 优化QEMU性能的启动参数说明：

-smp 2                    # 双核CPU，提升性能
-m 1057                   # 1GB内存，足够运行测试
-machine virt,secure=on   # 启用TrustZone安全扩展
-cpu cortex-a57           # 高性能ARMv8 CPU
-nographic               # 无图形界面，提升性能
```

---

## 🧪 第一个测试运行

### Hello World示例测试

```bash
# 1. 构建Hello World示例
cd $AIRACCOUNT_ROOT
cd third_party/incubator-teaclave-trustzone-sdk/examples/hello_world-rs

# 2. 构建TA和CA
make

# 3. 复制构建产物到共享目录
cp ta/target/aarch64-unknown-optee/release/*.ta ../../../tests/shared/
cp host/target/aarch64-unknown-linux-gnu/release/hello_world-rs ../../../tests/shared/hello-ca

# 4. 启动QEMU（如果还没启动）
cd ../../../tests
./optee-qemuv8-fixed.sh aarch64-optee-4.7.0-qemuv8-ubuntu-24.04

# 5. 在QEMU中测试
root@buildroot:~# mount -t 9p -o trans=virtio host /shared
root@buildroot:~# cd /shared

# 6. 安装TA
root@buildroot:/shared# cp *.ta /lib/optee_armtz/

# 7. 运行CA测试
root@buildroot:/shared# chmod +x hello-ca
root@buildroot:/shared# ./hello-ca
# 应该看到成功输出：
# Invoking TA to increment 42
# TA incremented value to 43
```

### AirAccount核心功能测试

现在测试我们的核心AirAccount功能：

```bash
# 1. 构建AirAccount TA和CA
cd $AIRACCOUNT_ROOT

# 2. 构建Core Logic库
cd packages/core-logic
cargo test --all-features  # 运行单元测试
cargo build --release      # 构建发布版本

# 3. 构建TA（如果存在）
# cd packages/ta-arm-trustzone
# make

# 4. 构建CA（如果存在）  
# cd packages/client-ca
# make

# 注意：当前项目重点在Core Logic层，TA/CA可能还在开发中
```

### 预置测试脚本运行

项目提供了多个测试脚本：

```bash
# 1. ETH钱包功能测试
cd third_party/incubator-teaclave-trustzone-sdk/tests
./test_eth_wallet.sh

# 2. AirAccount专用测试
./test_airaccount.sh

# 3. 完整的加密和签名测试
./test_authentication.sh
./test_signature_verification.sh

# 4. 查看测试输出
tail -f test_output.log
```

---

## 🔧 核心功能测试

### 钱包管理功能测试

```bash
# 在项目根目录执行
cd packages/core-logic

# 1. 运行钱包核心测试
cargo test wallet::core_wallet::tests::test_wallet_creation -- --nocapture

# 2. 运行增强钱包管理测试  
cargo test wallet::enhanced_wallet_manager::tests::test_enhanced_wallet_creation -- --nocapture

# 3. 运行地址派生测试
cargo test wallet::core_wallet::tests::test_address_checksum -- --nocapture
```

### 安全模块测试

```bash
# 1. 内存保护测试
cargo test security::memory_protection::tests::test_secure_memory -- --nocapture

# 2. 密钥派生测试
cargo test security::key_derivation::tests::test_key_derivation -- --nocapture

# 3. 安全启动测试
cargo test security::secure_boot::tests::test_secure_boot_manager -- --nocapture

# 4. 审计系统测试
cargo test security::audit::tests::test_audit_logger -- --nocapture
```

### 加密和签名测试

```bash
# 1. 常量时间操作测试
cargo test security::constant_time::tests::test_constant_time_ops_secure_compare -- --nocapture

# 2. SIMD安全操作测试
cargo test security::simd_ops::tests::test_simd_secure_compare -- --nocapture

# 3. 熵收集和随机数测试
cargo test security::entropy::tests::test_hardware_rng_availability -- --nocapture
```

### 完整测试套件

```bash
# 运行所有测试（需要几分钟）
cargo test --all-features

# 只运行通过的测试
cargo test --all-features -- --skip test_statistics

# 生成测试报告
cargo test --all-features -- --format json > test_results.json
```

---

## 🐛 代码修改和调试

### 开发工作流程

#### 1. 创建功能分支

```bash
# 1. 从main分支创建功能分支
git checkout main
git pull origin main
git checkout -b feature/your-feature-name

# 2. 查看当前分支状态
git status
```

#### 2. 代码修改示例

让我们尝试添加一个简单的新功能：

```bash
# 1. 在core-logic中添加新功能
cd packages/core-logic/src

# 2. 创建新的测试模块
cat > tests/new_feature_test.rs << 'EOF'
//! 新功能测试示例

use crate::security::SecurityError;

#[derive(Debug)]
pub struct NewFeature {
    name: String,
}

impl NewFeature {
    pub fn new(name: &str) -> Self {
        Self {
            name: name.to_string(),
        }
    }
    
    pub fn get_name(&self) -> &str {
        &self.name
    }
}

#[cfg(test)]
mod tests {
    use super::*;
    
    #[test]
    fn test_new_feature_creation() {
        let feature = NewFeature::new("test");
        assert_eq!(feature.get_name(), "test");
    }
}
EOF

# 3. 将新模块添加到lib.rs
echo "pub mod new_feature_test;" >> lib.rs
```

#### 3. 运行测试验证

```bash
# 1. 运行新功能测试
cargo test new_feature_test

# 2. 运行所有测试确保没有回归
cargo test --all-features

# 3. 检查代码格式
cargo fmt

# 4. 检查代码质量
cargo clippy
```

### 调试技巧

#### 1. 使用日志调试

```rust
// 在代码中添加调试日志
use log::{info, debug, error};

debug!("调试信息: 变量值 = {}", variable);
info!("信息: 操作完成");
error!("错误: 操作失败");
```

#### 2. 使用测试调试

```rust
#[test]
fn debug_test() {
    // 使用println!在测试中输出调试信息
    println!("调试输出: {:?}", some_variable);
    
    // 使用 --nocapture 查看输出
    // cargo test debug_test -- --nocapture
}
```

#### 3. 在QEMU中调试

```bash
# 1. 在TA中添加调试输出
# TEE_INFO("调试信息: %s", debug_string);

# 2. 查看QEMU日志
tail -f /tmp/serial.log

# 3. 使用strace跟踪CA
root@buildroot:/shared# strace ./your-ca-binary
```

### 性能分析

```bash
# 1. 运行性能测试
cargo test --release performance -- --nocapture

# 2. 使用criterion进行基准测试（如果配置了）
cargo bench

# 3. 内存使用分析
valgrind ./target/debug/your-binary  # 在Linux上
```

---

## 🚀 开发工作流程

### 日常开发流程

#### 1. 开始新功能开发

```bash
# 1. 更新代码库
git pull origin main

# 2. 创建功能分支
git checkout -b feature/wallet-enhancement

# 3. 查看当前任务
# 参考 TODO.md 或 GitHub Issues
```

#### 2. 代码修改和测试

```bash
# 1. 修改代码
# 使用您喜欢的IDE编辑代码

# 2. 运行相关测试
cargo test security::  # 测试安全模块
cargo test wallet::   # 测试钱包模块

# 3. 运行完整测试套件
cargo test --all-features
```

#### 3. 在QEMU中验证

```bash
# 1. 如果修改了TA相关代码
cd packages/ta-arm-trustzone
make clean && make

# 2. 复制到共享目录
cp target/aarch64-unknown-optee/release/*.ta ../../../third_party/incubator-teaclave-trustzone-sdk/tests/shared/

# 3. 在QEMU中测试
cd ../../../third_party/incubator-teaclave-trustzone-sdk/tests
./optee-qemuv8-fixed.sh aarch64-optee-4.7.0-qemuv8-ubuntu-24.04

# 在QEMU中：
root@buildroot:~# mount -t 9p -o trans=virtio host /shared
root@buildroot:~# cp /shared/*.ta /lib/optee_armtz/
root@buildroot:~# /shared/your-test-ca
```

#### 4. 提交代码

```bash
# 1. 查看修改状态
git status
git diff

# 2. 添加修改的文件
git add packages/core-logic/src/wallet/new_feature.rs
git add packages/core-logic/src/wallet/mod.rs

# 3. 提交修改
git commit -m "feat: 添加钱包新功能

- 实现新的钱包增强功能
- 添加相应的单元测试
- 通过QEMU环境验证"

# 4. 推送到远程分支
git push origin feature/wallet-enhancement
```

### 代码审查流程

#### 1. 创建Pull Request

```bash
# 1. 推送分支后，在GitHub创建PR
# 2. 填写PR模板：
#    - 功能描述
#    - 测试结果
#    - 相关Issue链接
#    - 截图或日志输出
```

#### 2. 代码审查检查清单

在提交PR前，请确保：

- [ ] 所有测试通过：`cargo test --all-features`
- [ ] 代码格式正确：`cargo fmt`
- [ ] 没有编译警告：`cargo clippy`
- [ ] 在QEMU环境中验证过（如果相关）
- [ ] 添加了相应的单元测试
- [ ] 更新了相关文档
- [ ] commit消息清晰描述了修改内容

### CI/CD集成

项目配置了自动化测试：

```yaml
# .github/workflows/test.yml 示例
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive
      - name: Install Rust
        uses: actions-rs/toolchain@v1
      - name: Run tests
        run: cargo test --all-features
      - name: Run QEMU tests
        run: ./scripts/test_in_qemu.sh
```

---

## 📚 代码贡献指南

### 代码风格和约定

#### 1. Rust代码风格

```rust
// ✅ 好的代码风格
pub struct WalletManager {
    /// 钱包存储
    wallets: HashMap<WalletId, WalletCore>,
    /// 安全配置
    config: SecurityConfig,
}

impl WalletManager {
    /// 创建新的钱包管理器
    pub fn new(config: SecurityConfig) -> Result<Self, SecurityError> {
        Ok(Self {
            wallets: HashMap::new(),
            config,
        })
    }
    
    /// 创建新钱包
    pub fn create_wallet(&mut self, params: WalletParams) -> Result<WalletId, SecurityError> {
        // 参数验证
        self.validate_params(&params)?;
        
        // 创建钱包
        let wallet = WalletCore::new(params)?;
        let wallet_id = wallet.id();
        
        // 存储钱包
        self.wallets.insert(wallet_id, wallet);
        
        Ok(wallet_id)
    }
}
```

#### 2. 错误处理规范

```rust
// ✅ 使用结构化错误处理
use crate::error::SecurityError;

pub fn risky_operation() -> Result<String, SecurityError> {
    // 明确的错误类型
    let data = read_sensitive_data()
        .map_err(|e| SecurityError::crypto_error("read_data", &e.to_string(), "wallet_manager"))?;
    
    Ok(data)
}

// ✅ 在测试中验证错误
#[test]
fn test_error_handling() {
    let result = risky_operation();
    match result {
        Err(SecurityError::CryptoError { operation, .. }) => {
            assert_eq!(operation, "read_data");
        }
        _ => panic!("期望CryptoError"),
    }
}
```

#### 3. 测试规范

```rust
#[cfg(test)]
mod tests {
    use super::*;
    
    #[test]
    fn test_wallet_creation_success() {
        // 准备测试数据
        let config = SecurityConfig::default();
        let mut manager = WalletManager::new(config).unwrap();
        
        let params = WalletParams {
            name: "test_wallet".to_string(),
            chain_id: 1,
        };
        
        // 执行测试
        let wallet_id = manager.create_wallet(params).unwrap();
        
        // 验证结果
        assert!(!wallet_id.is_empty());
        assert_eq!(manager.wallets.len(), 1);
    }
    
    #[test]
    fn test_wallet_creation_invalid_params() {
        // 测试错误情况
        let config = SecurityConfig::default();
        let mut manager = WalletManager::new(config).unwrap();
        
        let invalid_params = WalletParams {
            name: "".to_string(), // 无效名称
            chain_id: 0,          // 无效链ID
        };
        
        // 验证错误处理
        let result = manager.create_wallet(invalid_params);
        assert!(result.is_err());
    }
}
```

### 文档编写规范

#### 1. 代码文档

```rust
/// 钱包管理器
/// 
/// 提供钱包的创建、管理和安全操作功能。所有操作都经过安全验证，
/// 私钥永远不会离开TEE环境。
/// 
/// # 示例
/// 
/// ```rust
/// let config = SecurityConfig::default();
/// let mut manager = WalletManager::new(config)?;
/// 
/// let params = WalletParams::new("my_wallet", 1);
/// let wallet_id = manager.create_wallet(params)?;
/// ```
/// 
/// # 安全注意事项
/// 
/// - 所有钱包操作都需要通过TEE验证
/// - 私钥存储在硬件安全存储中
/// - 支持多重签名验证
pub struct WalletManager {
    // ...
}
```

#### 2. README和文档更新

```markdown
## 新功能：增强钱包管理

### 功能描述

新增了增强型钱包管理器，支持：
- 批量钱包操作
- 高级安全策略
- 性能优化的SIMD操作

### 使用示例

\```rust
use airaccount_core_logic::wallet::EnhancedWalletManager;

let manager = EnhancedWalletManager::new(config)?;
let wallets = manager.create_batch_wallets(params_list)?;
\```

### 测试验证

\```bash
cargo test wallet::enhanced_wallet_manager
\```
```

### 提交信息规范

使用[Conventional Commits](https://www.conventionalcommits.org/)格式：

```bash
# 功能添加
git commit -m "feat(wallet): 添加批量钱包创建功能

- 支持一次创建多个钱包
- 优化内存使用
- 添加相应单元测试

Closes #123"

# Bug修复
git commit -m "fix(security): 修复内存泄漏问题

- 在安全内存分配中正确清理资源
- 添加内存泄漏检测测试
- 通过valgrind验证

Fixes #456"

# 文档更新
git commit -m "docs: 更新QEMU环境搭建指南

- 添加macOS特定配置说明
- 更新依赖安装命令
- 修正示例代码错误"
```

---

## 🔗 相关文档链接

### 项目核心文档

- [项目架构设计](./Solution.md) - 了解整体技术方案
- [部署指南](./Deploy_zh.md) - 生产环境部署说明
- [TEE开发指南](./TEE-Development-Guide.md) - 深入的TEE开发教程
- [安全评估报告](./Security_Assessment_Report.md) - 安全特性详细说明

### 技术栈文档

- [Apache Teaclave TrustZone SDK](https://teaclave.apache.org/) - TEE开发框架
- [OP-TEE Documentation](https://optee.readthedocs.io/) - OP-TEE官方文档
- [QEMU ARM System Emulation](https://www.qemu.org/docs/master/system/arm/virt.html) - QEMU ARM虚拟化
- [Rust TEE Programming](https://rust-lang.org/) - Rust语言官方文档

### 开发工具

- [Visual Studio Code](https://code.visualstudio.com/) + [Rust Analyzer](https://rust-analyzer.github.io/)
- [CLion](https://www.jetbrains.com/clion/) - JetBrains的Rust IDE
- [Rust语言服务器](https://github.com/rust-lang/rls) - 编辑器集成

---

## 🆘 常见问题和故障排除

### QEMU相关问题

#### 问题1：QEMU启动失败
```bash
# 症状：qemu-system-aarch64: command not found
# 解决方案：
brew install qemu  # macOS
sudo apt install qemu-system-arm  # Ubuntu

# 验证安装：
qemu-system-aarch64 --version
```

#### 问题2：共享目录挂载失败
```bash
# 症状：mount: mounting host on /shared failed
# 解决方案：
# 1. 确保共享目录存在
mkdir -p third_party/incubator-teaclave-trustzone-sdk/tests/shared

# 2. 检查QEMU启动参数
grep "virtio-9p" optee-qemuv8-fixed.sh

# 3. 在QEMU中重新挂载
mount -t 9p -o trans=virtio,version=9p2000.L host /shared
```

#### 问题3：TA加载失败
```bash
# 症状：Error: Failed to open session with the TA
# 解决方案：
# 1. 检查TA文件是否正确复制
ls -la /lib/optee_armtz/

# 2. 检查TA文件格式
file /lib/optee_armtz/*.ta
# 应该显示：data

# 3. 检查UUID匹配
grep -r "11223344-5566-7788" .
```

### 编译相关问题

#### 问题1：依赖项安装失败
```bash
# 症状：Could not find system library 'xxx' required by the 'yyy' crate
# 解决方案 - macOS：
brew install openssl libffi

# 解决方案 - Ubuntu：
sudo apt install libssl-dev libffi-dev pkg-config
```

#### 问题2：交叉编译失败
```bash
# 症状：linker `aarch64-linux-gnu-gcc` not found
# 解决方案：
rustup target add aarch64-unknown-linux-gnu
# 或者安装交叉编译工具链
```

#### 问题3：测试超时
```bash
# 症状：test has been running for over 60 seconds
# 解决方案：
# 1. 单独运行耗时测试
cargo test test_statistics -- --nocapture

# 2. 设置测试超时
RUST_TEST_TIME_INTEGRATION=300 cargo test

# 3. 跳过耗时测试
cargo test -- --skip test_statistics
```

### 开发环境问题

#### 问题1：Git子模块问题
```bash
# 症状：Submodule path 'third_party/...' not initialized
# 解决方案：
git submodule update --init --recursive

# 强制重新初始化：
git submodule deinit --all -f
git submodule update --init --recursive
```

#### 问题2：权限问题
```bash
# 症状：Permission denied
# 解决方案：
# 1. 检查文件权限
ls -la third_party/incubator-teaclave-trustzone-sdk/tests/shared/

# 2. 修正权限
chmod +x your-binary-file

# 3. 在QEMU中设置权限
chmod +x /shared/your-binary
```

### 性能问题

#### 问题1：QEMU运行缓慢
```bash
# 解决方案：
# 1. 增加CPU核心数
# 修改optee-qemuv8-fixed.sh中的 -smp 参数

# 2. 增加内存
# 修改 -m 参数为更大值

# 3. 启用硬件加速（如果支持）
# 添加 -enable-kvm 参数（Linux主机）
```

#### 问题2：编译时间过长
```bash
# 解决方案：
# 1. 使用release模式编译
cargo build --release

# 2. 并行编译
export CARGO_BUILD_JOBS=$(nproc)

# 3. 使用sccache加速
cargo install sccache
export RUSTC_WRAPPER=sccache
```

---

## 📞 获取帮助

### 内部资源

- **技术文档**：查看 `docs/` 目录下的详细文档
- **代码示例**：参考 `third_party/incubator-teaclave-trustzone-sdk/examples/`
- **测试用例**：学习 `packages/core-logic/src/*/tests/` 中的测试

### 外部资源

- **OP-TEE社区**：[OP-TEE GitHub](https://github.com/OP-TEE/optee_os)
- **Teaclave社区**：[Apache Teaclave](https://github.com/apache/incubator-teaclave)
- **Rust社区**：[Rust Users Forum](https://users.rust-lang.org/)

### 报告问题

在报告问题时，请包含：

1. **环境信息**：
   ```bash
   uname -a
   rustc --version
   qemu-system-aarch64 --version
   ```

2. **错误日志**：完整的错误输出和堆栈跟踪

3. **重现步骤**：详细的操作步骤

4. **期望结果**：您期望看到的结果

---

## 🎉 欢迎加入AirAccount项目！

通过本指南，您应该已经：

✅ 理解了AirAccount项目的架构和目标  
✅ 搭建了完整的开发环境  
✅ 成功运行了QEMU+OP-TEE模拟环境  
✅ 完成了第一次测试运行  
✅ 了解了日常开发工作流程  
✅ 掌握了代码贡献规范

现在您已经准备好为这个exciting的TEE项目做出贡献了！

### 下一步建议

1. **深入学习**：阅读[安全评估报告](./Security_Assessment_Report.md)了解安全设计
2. **实践练习**：尝试修改一个小功能并提交PR
3. **参与讨论**：加入项目的技术讨论和代码审查
4. **持续学习**：跟上TEE和区块链技术的最新发展

**Happy Coding! 🚀**

---

*最后更新：2025年1月*  
*文档版本：v1.0*  
*适用项目版本：AirAccount v1.0-PRODUCTION-READY*