#!/usr/bin/expect -f
# å¿«é€ŸCA-TAæµ‹è¯•è„šæœ¬

set timeout 60

# å¯åŠ¨QEMU
spawn screen -d -m -S ca_test_session
send "cd /Volumes/UltraDisk/Dev2/aastar/AirAccount/third_party/incubator-teaclave-trustzone-sdk/tests\r"
send "./optee-qemuv8-fixed.sh aarch64-optee-4.7.0-qemuv8-ubuntu-24.04\r"

# ç­‰å¾…QEMUå¯åŠ¨
sleep 15
send "root\r"

# æŒ‚è½½å…±äº«ç›®å½•
send "mkdir -p /shared && mount -t 9p host /shared\r"
sleep 2

# æ£€æŸ¥æ–‡ä»¶
send "ls /shared/ | grep -E '(ta|ca)'\r"
expect "airaccount-ca"

# å®‰è£…TA
send "cp /shared/11223344-5566-7788-99aa-bbccddeeff01.ta /lib/optee_armtz/\r"
sleep 1

puts "ğŸ§ª æµ‹è¯•ä¿®å¤åçš„Simple CA-TA"

# æµ‹è¯•1: Hello World
puts "æµ‹è¯•1: Hello World"
send "/shared/airaccount-ca hello\r"
sleep 3

# æµ‹è¯•2: Echo
puts "æµ‹è¯•2: Echo"
send "/shared/airaccount-ca echo 'Test Message'\r"
sleep 3

# æµ‹è¯•3: å®Œæ•´æµ‹è¯•å¥—ä»¶
puts "æµ‹è¯•3: å®Œæ•´æµ‹è¯•å¥—ä»¶"
send "/shared/airaccount-ca test\r"
sleep 5

puts "âœ… CA-TAæµ‹è¯•å®Œæˆ"
send "exit\r"
expect eof