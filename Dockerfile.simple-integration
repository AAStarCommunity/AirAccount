FROM ubuntu:24.04

# 设置环境
ENV DEBIAN_FRONTEND=noninteractive

# 安装必要依赖
RUN apt-get update && apt-get install -y \
    qemu-system-aarch64 \
    file \
    bsdmainutils \
    util-linux \
    && rm -rf /var/lib/apt/lists/*

# 创建工作目录
WORKDIR /test

# 复制构建产物
COPY packages/airaccount-ta-simple/target/aarch64-unknown-linux-gnu/release/11223344-5566-7788-99aa-bbccddeeff01.ta ./
COPY packages/airaccount-ca/target/aarch64-unknown-linux-gnu/debug/airaccount-ca ./

# 设置权限
RUN chmod +x ./airaccount-ca

# 创建测试脚本
RUN echo '#!/bin/bash' > ./run_basic_tests.sh && \
    echo 'echo "🧪 AirAccount基础功能模拟测试"' >> ./run_basic_tests.sh && \
    echo 'echo "==========================="' >> ./run_basic_tests.sh && \
    echo 'echo ""' >> ./run_basic_tests.sh && \
    echo '# 基础组件验证' >> ./run_basic_tests.sh && \
    echo 'echo "📋 组件检查:"' >> ./run_basic_tests.sh && \
    echo 'ta_file=$(ls *.ta 2>/dev/null | head -1)' >> ./run_basic_tests.sh && \
    echo 'if [ -f "$ta_file" ]; then' >> ./run_basic_tests.sh && \
    echo '  echo "  ✅ TA文件: $ta_file ($(stat -c%s "$ta_file") bytes)"' >> ./run_basic_tests.sh && \
    echo '  if hexdump -C "$ta_file" | head -1 | grep -q "48 53 54 4f"; then' >> ./run_basic_tests.sh && \
    echo '    echo "     ✅ OP-TEE格式验证通过"' >> ./run_basic_tests.sh && \
    echo '  fi' >> ./run_basic_tests.sh && \
    echo 'fi' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo 'if [ -f "./airaccount-ca" ]; then' >> ./run_basic_tests.sh && \
    echo '  echo "  ✅ CA文件: airaccount-ca ($(stat -c%s ./airaccount-ca) bytes)"' >> ./run_basic_tests.sh && \
    echo '  echo "     架构: $(file ./airaccount-ca | grep -o "ARM aarch64" || echo "未检测到ARM64")"' >> ./run_basic_tests.sh && \
    echo 'fi' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo 'echo ""' >> ./run_basic_tests.sh && \
    echo 'echo "🖥️  QEMU环境检查:"' >> ./run_basic_tests.sh && \
    echo 'if command -v qemu-system-aarch64 >/dev/null 2>&1; then' >> ./run_basic_tests.sh && \
    echo '  echo "  ✅ QEMU可用: $(qemu-system-aarch64 --version | head -1)"' >> ./run_basic_tests.sh && \
    echo '  qemu_available=1' >> ./run_basic_tests.sh && \
    echo 'else' >> ./run_basic_tests.sh && \
    echo '  echo "  ❌ QEMU不可用"' >> ./run_basic_tests.sh && \
    echo '  qemu_available=0' >> ./run_basic_tests.sh && \
    echo 'fi' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo 'echo ""' >> ./run_basic_tests.sh && \
    echo 'echo "🧪 模拟测试（无实际TEE环境）:"' >> ./run_basic_tests.sh && \
    echo 'echo "  ℹ️  由于缺少完整的OP-TEE环境，执行模拟测试"' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo '# Test 1: 文件完整性验证' >> ./run_basic_tests.sh && \
    echo 'echo "  Test 1: 文件完整性验证"' >> ./run_basic_tests.sh && \
    echo 'if [ -f "$ta_file" ] && [ -f "./airaccount-ca" ]; then' >> ./run_basic_tests.sh && \
    echo '  echo "     ✅ 所有必需文件存在"' >> ./run_basic_tests.sh && \
    echo '  test1_pass=1' >> ./run_basic_tests.sh && \
    echo 'else' >> ./run_basic_tests.sh && \
    echo '  echo "     ❌ 文件缺失"' >> ./run_basic_tests.sh && \
    echo '  test1_pass=0' >> ./run_basic_tests.sh && \
    echo 'fi' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo '# Test 2: CA可执行性检查' >> ./run_basic_tests.sh && \
    echo 'echo "  Test 2: CA可执行性检查"' >> ./run_basic_tests.sh && \
    echo 'if file ./airaccount-ca | grep -q "executable"; then' >> ./run_basic_tests.sh && \
    echo '  echo "     ✅ CA文件为可执行格式"' >> ./run_basic_tests.sh && \
    echo '  test2_pass=1' >> ./run_basic_tests.sh && \
    echo 'else' >> ./run_basic_tests.sh && \
    echo '  echo "     ❌ CA文件格式错误"' >> ./run_basic_tests.sh && \
    echo '  test2_pass=0' >> ./run_basic_tests.sh && \
    echo 'fi' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo '# Test 3: 尝试基本的帮助输出（可能失败，因为需要OP-TEE）' >> ./run_basic_tests.sh && \
    echo 'echo "  Test 3: CA基本功能测试"' >> ./run_basic_tests.sh && \
    echo 'timeout 5 ./airaccount-ca --help 2>/dev/null >/dev/null && help_exit=$? || help_exit=$?' >> ./run_basic_tests.sh && \
    echo 'if [ "$help_exit" -eq 0 ] || [ "$help_exit" -eq 1 ]; then' >> ./run_basic_tests.sh && \
    echo '  echo "     ✅ CA程序可以启动（退出码: $help_exit）"' >> ./run_basic_tests.sh && \
    echo '  test3_pass=1' >> ./run_basic_tests.sh && \
    echo 'elif [ "$help_exit" -eq 124 ]; then' >> ./run_basic_tests.sh && \
    echo '  echo "     ⚠️  CA程序超时（可能等待TEE连接）"' >> ./run_basic_tests.sh && \
    echo '  test3_pass=1' >> ./run_basic_tests.sh && \
    echo 'else' >> ./run_basic_tests.sh && \
    echo '  echo "     ❌ CA程序启动失败（退出码: $help_exit）"' >> ./run_basic_tests.sh && \
    echo '  test3_pass=0' >> ./run_basic_tests.sh && \
    echo 'fi' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo '# 总结' >> ./run_basic_tests.sh && \
    echo 'echo ""' >> ./run_basic_tests.sh && \
    echo 'echo "📊 测试结果总结:"' >> ./run_basic_tests.sh && \
    echo 'total_tests=3' >> ./run_basic_tests.sh && \
    echo 'passed_tests=$((test1_pass + test2_pass + test3_pass))' >> ./run_basic_tests.sh && \
    echo 'echo "  通过测试: $passed_tests/$total_tests"' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo 'if [ "$passed_tests" -eq "$total_tests" ]; then' >> ./run_basic_tests.sh && \
    echo '  echo "  🎉 所有基础测试通过！"' >> ./run_basic_tests.sh && \
    echo '  echo "  ✅ AirAccount组件已准备就绪，可部署到真实的OP-TEE环境"' >> ./run_basic_tests.sh && \
    echo 'elif [ "$passed_tests" -gt 1 ]; then' >> ./run_basic_tests.sh && \
    echo '  echo "  ✅ 大部分测试通过，组件基本就绪"' >> ./run_basic_tests.sh && \
    echo '  echo "  ℹ️  建议在真实OP-TEE环境中进行完整测试"' >> ./run_basic_tests.sh && \
    echo 'else' >> ./run_basic_tests.sh && \
    echo '  echo "  ❌ 多个测试失败，需要检查构建问题"' >> ./run_basic_tests.sh && \
    echo 'fi' >> ./run_basic_tests.sh && \
    echo '' >> ./run_basic_tests.sh && \
    echo 'echo ""' >> ./run_basic_tests.sh && \
    echo 'echo "🚀 下一步建议:"' >> ./run_basic_tests.sh && \
    echo 'echo "  1. 在真实的ARM64 Linux + OP-TEE环境中部署测试"' >> ./run_basic_tests.sh && \
    echo 'echo "  2. 复制TA文件到 /lib/optee_armtz/"' >> ./run_basic_tests.sh && \
    echo 'echo "  3. 运行命令：./airaccount-ca hello"' >> ./run_basic_tests.sh && \
    echo 'echo "  4. 运行命令：./airaccount-ca echo \\"Hello TEE\\""' >> ./run_basic_tests.sh && \
    echo 'echo "  5. 运行命令：./airaccount-ca test"' >> ./run_basic_tests.sh

# 设置权限
RUN chmod +x ./run_basic_tests.sh

# 默认命令
CMD ["./run_basic_tests.sh"]