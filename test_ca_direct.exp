#!/usr/bin/expect -f
# ç›´æ¥æµ‹è¯•CA-TAé€šä¿¡

set timeout 30

# è¿æ¥åˆ°è¿è¡Œçš„QEMU
spawn screen -r
expect "# " {
    puts "âœ… è¿æ¥åˆ°QEMUæˆåŠŸ"
}

# æ£€æŸ¥å…±äº«ç›®å½•
send "ls /shared/ | grep airaccount\r"
expect {
    "airaccount-ca" {
        puts "âœ… æ‰¾åˆ°CAæ–‡ä»¶"
    }
    timeout {
        puts "âŒ æœªæ‰¾åˆ°CAæ–‡ä»¶"
        exit 1
    }
}

# æµ‹è¯•Hello Worldå‘½ä»¤
puts "ğŸ§ª æµ‹è¯•1: Hello World"
send "/shared/airaccount-ca hello\r"
expect {
    "AirAccount" {
        puts "âœ… Hello Worldæµ‹è¯•é€šè¿‡"
    }
    "error" {
        puts "âŒ Hello Worldæµ‹è¯•å¤±è´¥"
    }
    timeout {
        puts "âŒ Hello Worldæµ‹è¯•è¶…æ—¶"
    }
}

# æµ‹è¯•Echoå‘½ä»¤
puts "ğŸ§ª æµ‹è¯•2: Echo"
send "/shared/airaccount-ca echo 'Test Message'\r"
expect {
    "Test Message" {
        puts "âœ… Echoæµ‹è¯•é€šè¿‡"
    }
    "error" {
        puts "âŒ Echoæµ‹è¯•å¤±è´¥"
    }
    timeout {
        puts "âŒ Echoæµ‹è¯•è¶…æ—¶"
    }
}

# æµ‹è¯•å®Œæ•´æµ‹è¯•å¥—ä»¶
puts "ğŸ§ª æµ‹è¯•3: å®Œæ•´æµ‹è¯•å¥—ä»¶"
send "/shared/airaccount-ca test\r"
expect {
    "All tests PASSED" {
        puts "âœ… å®Œæ•´æµ‹è¯•å¥—ä»¶é€šè¿‡"
    }
    "tests passed" {
        puts "âœ… éƒ¨åˆ†æµ‹è¯•é€šè¿‡"
    }
    "error" {
        puts "âŒ æµ‹è¯•å¥—ä»¶å¤±è´¥"
    }
    timeout {
        puts "âŒ æµ‹è¯•å¥—ä»¶è¶…æ—¶"
    }
}

puts "ğŸ‰ CAæµ‹è¯•å®Œæˆ"
send "exit\r"
expect eof